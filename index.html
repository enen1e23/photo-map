<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>ğŸ“¸ ç…§ç‰‡åœ°å›¾ç”Ÿæˆå™¨ï¼ˆç½‘é¡µç‰ˆï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet åœ°å›¾æ ·å¼ -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <!-- ç®€å•é¡µé¢æ ·å¼ -->
  <style>
    * {
      box-sizing: border-box;
    }
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: "Segoe UI", "Microsoft YaHei", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f5f5f5;
    }
    .layout {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    .top-bar {
      padding: 10px 16px;
      background: #ffffff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.08);
      z-index: 10;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 8px 16px;
    }
    .top-bar-title {
      font-size: 18px;
      font-weight: 600;
      margin-right: 16px;
      white-space: nowrap;
    }
    .top-bar input[type="text"] {
      padding: 4px 8px;
      border-radius: 4px;
      border: 1px solid #ddd;
      min-width: 220px;
    }
    .top-bar label {
      font-size: 13px;
      color: #555;
    }
    .top-bar input[type="file"] {
      font-size: 13px;
    }
    .btn {
      padding: 6px 12px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .btn-primary {
      background: #4CAF50;
      color: #fff;
    }
    .btn-primary:hover {
      background: #43a047;
    }
    .btn-secondary {
      background: #e0e0e0;
      color: #333;
    }
    .btn-secondary:hover {
      background: #d5d5d5;
    }
    .status-text {
      font-size: 12px;
      color: #666;
      margin-left: auto;
      white-space: nowrap;
    }
    .content {
      flex: 1;
      position: relative;
    }
    #map {
      width: 100%;
      height: 100%;
    }
    .leaflet-container {
      background: #dde3ea;
    }

    /* å¼¹å‡ºæ¡†æ ·å¼ */
    .photo-popup {
      text-align: center;
      min-width: 250px;
    }
    .photo-popup img {
      width: 100%;
      max-width: 400px;
      border-radius: 8px;
      margin-bottom: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .photo-popup .info {
      font-size: 13px;
      color: #555;
      line-height: 1.6;
    }
    .photo-popup .info strong {
      color: #333;
    }
    .photo-marker {
      background: #4CAF50;
      border: 3px solid white;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      cursor: pointer;
    }
    .leaflet-popup-content {
      margin: 15px;
    }

    .small-text {
      font-size: 11px;
      color: #999;
    }
  </style>
</head>
<body>
  <div class="layout">
    <div class="top-bar">
      <div class="top-bar-title">ğŸ“¸ ç…§ç‰‡åœ°å›¾ç”Ÿæˆå™¨ï¼ˆç½‘é¡µç‰ˆï¼‰</div>

      <label>
        æ ‡é¢˜ï¼š
        <input type="text" id="titleInput" placeholder="ä¾‹å¦‚ï¼šå¤©æ´¥æ—…è¡Œåœ°å›¾" />
      </label>

      <label>
        é€‰æ‹©ç…§ç‰‡æ–‡ä»¶å¤¹ï¼š
        <!-- webkitdirectory ä»…åœ¨åŸºäº Chromium çš„æµè§ˆå™¨ä¸­å¯ç”¨ï¼ˆChrome / Edgeï¼‰ -->
        <input type="file" id="dirInput" webkitdirectory multiple accept="image/*">
      </label>

      <label>
        æˆ–é€‰æ‹©ç…§ç‰‡æ–‡ä»¶ï¼š
        <input type="file" id="fileInput" multiple accept="image/*">
      </label>

      <button id="generateBtn" class="btn btn-primary">ğŸš€ ç”Ÿæˆåœ°å›¾</button>
      <!-- æ–°å¢ï¼šæ¸…ç©ºæŒ‰é’® -->
      <button id="clearBtn" class="btn btn-secondary">ğŸ§¹ æ¸…ç©ºé€‰æ‹©</button>

      <div class="status-text" id="statusText">è¯·é€‰æ‹©ç…§ç‰‡å¹¶ç‚¹å‡»â€œç”Ÿæˆåœ°å›¾â€ã€‚</div>

      <div class="small-text">
        ï¼ˆæ‰€æœ‰å¤„ç†éƒ½åœ¨æœ¬åœ°æµè§ˆå™¨å®Œæˆï¼Œä¸ä¼šä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼‰
      </div>
    </div>

    <div class="content">
      <div id="map"></div>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <!-- exif-jsï¼šç”¨æ¥è¯»å–ç…§ç‰‡ EXIF ä¿¡æ¯ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js"></script>

  <script>
    // =============== å·¥å…·å‡½æ•°ï¼šDMS -> åè¿›åˆ¶åº¦æ•° ===============
    function dmsToDecimal(dms, ref) {
      if (!dms || dms.length < 3 || !ref) return null;

      function toFloat(v) {
        if (typeof v === "number") return v;
        // exif-js å¯èƒ½è¿”å›å½¢å¦‚ {numerator: xx, denominator: xx}
        if (typeof v === "object" && v.numerator !== undefined && v.denominator) {
          return v.numerator / v.denominator;
        }
        // æˆ– "xx/yy" å­—ç¬¦ä¸²
        if (typeof v === "string") {
          const parts = v.split("/");
          if (parts.length === 2) {
            const num = parseFloat(parts[0]);
            const den = parseFloat(parts[1]);
            if (!isNaN(num) && !isNaN(den) && den !== 0) {
              return num / den;
            }
          } else {
            const f = parseFloat(v);
            if (!isNaN(f)) return f;
          }
        }
        return NaN;
      }

      const deg = toFloat(dms[0]);
      const min = toFloat(dms[1]);
      const sec = toFloat(dms[2]);

      if ([deg, min, sec].some(v => isNaN(v))) return null;

      let dec = deg + (min / 60.0) + (sec / 3600.0);
      ref = String(ref).toUpperCase();
      if (ref === "S" || ref === "W") {
        dec = -dec;
      }
      return dec;
    }

    // =============== å…¨å±€å˜é‡ï¼šåœ°å›¾å®ä¾‹ ===============
    let map = null;
    let markersLayer = null;
    let pathLayer = null;

    function initMapIfNeeded() {
      if (!map) {
        map = L.map("map").setView([34.0, 108.0], 5);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          maxZoom: 19,
          attribution: "Â© OpenStreetMap contributors"
        }).addTo(map);
      }
    }

    function clearMapLayers() {
      if (markersLayer) {
        markersLayer.remove();
        markersLayer = null;
      }
      if (pathLayer) {
        pathLayer.remove();
        pathLayer = null;
      }
    }

    // =============== å¤„ç†å•ä¸ªæ–‡ä»¶ï¼šè¯»å– EXIF + DataURL ===============
    function processFile(file) {
      return new Promise((resolve) => {
        const reader = new FileReader();

        reader.onload = function (e) {
          let tags;
          try {
            tags = EXIF.readFromBinaryFile(e.target.result);
          } catch (err) {
            console.warn("EXIF è§£æå¤±è´¥ï¼š", file.name, err);
            resolve(null);
            return;
          }

          const latDMS = tags.GPSLatitude;
          const lonDMS = tags.GPSLongitude;
          const latRef = tags.GPSLatitudeRef;
          const lonRef = tags.GPSLongitudeRef;

          const lat = dmsToDecimal(latDMS, latRef);
          const lon = dmsToDecimal(lonDMS, lonRef);

          if (lat === null || lon === null) {
            // æ²¡æœ‰ GPS ä¿¡æ¯ï¼Œè¿”å› null
            resolve(null);
            return;
          }

          // è·å–å…¶ä»–ä¿¡æ¯
          const dt = tags.DateTimeOriginal || tags.DateTime || null;
          const make = tags.Make || "";
          const model = tags.Model || "";
          const camera = (make && model) ? (make + " " + model) : (model || null);

          let altitude = null;
          if (tags.GPSAltitude) {
            const altVal = tags.GPSAltitude;
            if (typeof altVal === "object" && altVal.numerator !== undefined) {
              altitude = altVal.numerator / altVal.denominator;
            } else if (typeof altVal === "number") {
              altitude = altVal;
            }
          }

          // å†è¯»å–ä¸€æ¬¡æ–‡ä»¶ï¼Œè·å– DataURL ç”¨äºç¼©ç•¥å›¾
          const reader2 = new FileReader();
          reader2.onload = function (ev) {
            const dataUrl = ev.target.result;
            resolve({
              lat: lat,
              lon: lon,
              filename: file.name,
              datetime: dt ? String(dt) : null,
              camera: camera ? String(camera) : null,
              altitude: altitude,
              image: dataUrl
            });
          };
          reader2.onerror = function () {
            // å³ä½¿ç¼©ç•¥å›¾å¤±è´¥ï¼Œä¹Ÿè¿”å›åŸºæœ¬ä¿¡æ¯
            resolve({
              lat: lat,
              lon: lon,
              filename: file.name,
              datetime: dt ? String(dt) : null,
              camera: camera ? String(camera) : null,
              altitude: altitude,
              image: null
            });
          };
          reader2.readAsDataURL(file);
        };

        reader.onerror = function () {
          console.warn("æ–‡ä»¶è¯»å–å¤±è´¥ï¼š", file.name);
          resolve(null);
        };

        reader.readAsArrayBuffer(file);
      });
    }

    // =============== ä¸»æµç¨‹ï¼šç”Ÿæˆåœ°å›¾ ===============
    async function generateMapFromFiles(fileList) {
      const statusText = document.getElementById("statusText");

      if (!fileList || fileList.length === 0) {
        alert("è¯·å…ˆé€‰æ‹©è‡³å°‘ä¸€å¼ ç…§ç‰‡ã€‚");
        return;
      }

      statusText.textContent = `æ­£åœ¨è¯»å– ${fileList.length} å¼ ç…§ç‰‡çš„ EXIF ä¿¡æ¯ï¼Œè¯·ç¨å€™â€¦`;

      const files = Array.from(fileList);
      const photoInfos = [];

      let processed = 0;
      for (const file of files) {
        // åªå¤„ç†å›¾ç‰‡
        if (!file.type.startsWith("image/")) {
          processed++;
          continue;
        }
        const info = await processFile(file);
        if (info && info.lat !== null && info.lon !== null) {
          photoInfos.push(info);
        }
        processed++;
        statusText.textContent = `å·²å¤„ç† ${processed}/${files.length} å¼ ç…§ç‰‡â€¦`;
      }

      if (photoInfos.length === 0) {
        statusText.textContent = "æœªæ‰¾åˆ°åŒ…å« GPS ä¿¡æ¯çš„ç…§ç‰‡ã€‚";
        alert("æ²¡æœ‰å‘ç°å¸¦ GPS åæ ‡çš„ç…§ç‰‡ï¼Œæ— æ³•ç”Ÿæˆåœ°å›¾ã€‚");
        return;
      }

      // æŒ‰æ—¶é—´æ’åº
      photoInfos.sort((a, b) => {
        const da = a.datetime || "";
        const db = b.datetime || "";
        return da.localeCompare(db);
      });

      // è®¡ç®—ä¸­å¿ƒç‚¹
      const centerLat = photoInfos.reduce((sum, p) => sum + p.lat, 0) / photoInfos.length;
      const centerLon = photoInfos.reduce((sum, p) => sum + p.lon, 0) / photoInfos.length;

      initMapIfNeeded();
      clearMapLayers();

      map.setView([centerLat, centerLon], 12);

      markersLayer = L.layerGroup().addTo(map);

      const pathCoords = [];
      const markers = [];

      photoInfos.forEach((photo, idx) => {
        const index = idx + 1;
        pathCoords.push([photo.lat, photo.lon]);

        const markerIcon = L.divIcon({
          className: "photo-marker",
          html: index,
          iconSize: [30, 30]
        });

        let popupContent = '<div class="photo-popup">';
        if (photo.image) {
          popupContent += `<img src="${photo.image}" alt="${photo.filename}">`;
        }
        popupContent += '<div class="info">';
        popupContent += `<strong>ğŸ“· ${photo.filename}</strong><br>`;
        if (photo.datetime) {
          popupContent += `ğŸ• ${photo.datetime}<br>`;
        }
        if (photo.camera) {
          popupContent += `ğŸ“± ${photo.camera}<br>`;
        }
        if (photo.altitude !== null && !isNaN(photo.altitude)) {
          popupContent += `â›°ï¸ æµ·æ‹”: ${photo.altitude.toFixed(1)} m<br>`;
        }
        popupContent += `ğŸ“ ${photo.lat.toFixed(6)}, ${photo.lon.toFixed(6)}`;
        popupContent += "</div></div>";

        const marker = L.marker([photo.lat, photo.lon], { icon: markerIcon })
          .bindPopup(popupContent, { maxWidth: 450 })
          .addTo(markersLayer);

        markers.push(marker);
      });

      // æŠ˜çº¿è¿æ¥è½¨è¿¹
      if (pathCoords.length > 1) {
        pathLayer = L.polyline(pathCoords, {
          color: "#FF5722",
          weight: 3,
          opacity: 0.7,
          dashArray: "10,10",
          lineJoin: "round"
        }).addTo(map);
      }

      // è‡ªé€‚åº”è§†å›¾
      if (markers.length > 0) {
        const group = L.featureGroup(markers);
        map.fitBounds(group.getBounds().pad(0.1));
      }

      const titleInput = document.getElementById("titleInput");
      const title = titleInput.value.trim() || "æˆ‘çš„ç…§ç‰‡åœ°å›¾";
      statusText.textContent = `âœ… åœ°å›¾å·²ç”Ÿæˆï¼š${title}ï¼ˆå…± ${photoInfos.length} å¼ å¸¦ GPS çš„ç…§ç‰‡ï¼‰`;

      // ç”Ÿæˆå®Œåï¼Œè‡ªåŠ¨æ¸…ç©ºæ–‡ä»¶é€‰æ‹©ï¼ˆå¼ºåˆ¶ä¸‹æ¬¡é‡æ–°é€‰ï¼‰
      const dirInput = document.getElementById("dirInput");
      const fileInput = document.getElementById("fileInput");
      dirInput.value = "";
      fileInput.value = "";
    }

    // =============== äº‹ä»¶ç»‘å®š ===============
    window.addEventListener("DOMContentLoaded", () => {
      const dirInput = document.getElementById("dirInput");
      const fileInput = document.getElementById("fileInput");
      const generateBtn = document.getElementById("generateBtn");
      const clearBtn = document.getElementById("clearBtn");
      const titleInput = document.getElementById("titleInput");
      const statusText = document.getElementById("statusText");

      // é»˜è®¤æ ‡é¢˜
      titleInput.value = "æˆ‘çš„ç…§ç‰‡åœ°å›¾";

      generateBtn.addEventListener("click", () => {
        const dirFiles = dirInput.files;
        const normalFiles = fileInput.files;

        if (dirFiles && dirFiles.length > 0) {
          generateMapFromFiles(dirFiles);
        } else if (normalFiles && normalFiles.length > 0) {
          generateMapFromFiles(normalFiles);
        } else {
          alert("è¯·å…ˆé€‰æ‹©ç…§ç‰‡ï¼ˆæ–‡ä»¶å¤¹æˆ–æ–‡ä»¶éƒ½å¯ä»¥ï¼‰ã€‚");
        }
      });

      // æ–°å¢ï¼šæ¸…ç©ºæŒ‰é’®é€»è¾‘
      clearBtn.addEventListener("click", () => {
        dirInput.value = "";
        fileInput.value = "";
        clearMapLayers();
        if (map) {
          // åœ°å›¾æ¢å¤åˆ°ä¸€ä¸ªå¤§è‡´çš„å…¨å›½è§†è§’
          map.setView([34.0, 108.0], 5);
        }
        statusText.textContent = "å·²æ¸…ç©ºé€‰æ‹©ï¼Œè¯·é‡æ–°é€‰æ‹©ç…§ç‰‡å¹¶ç”Ÿæˆåœ°å›¾ã€‚";
      });

      // åˆå§‹åŒ–ä¸€ä¸ªç©ºåœ°å›¾èƒŒæ™¯
      initMapIfNeeded();
    });
  </script>
</body>
</html>

